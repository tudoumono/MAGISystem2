# 実装計画

## Phase 1: 基盤セットアップとStrands Agents統合

- [x] 1. Strands Agents基本プロジェクト構造の作成 **[🤖 Kiro]**
  - Python仮想環境とStrands Agentsライブラリのセットアップ
  - 3賢者（CASPAR、BALTHASAR、MELCHIOR）とSOLOMON Judgeのエージェント定義
  - MAGIシステム用システムプロンプトの実装（可決/否決判断機能付き）
  - エージェント設定管理とプリセットシステムの基盤構築
  - 学習用コメントと各エージェントの役割説明を詳細記載
  - **🤖 AI可読性**: エージェント設計パターンと実装判断を詳細解説
  - _要件: 1.1, 1.2, 4.1_

- [x] 2. SOLOMON統括システムの実装
  - [x] 2.1 SOLOMONエージェントの統括機能実装 **[🤖 Kiro]**
    - 3賢者をツールとして統合するSOLOMONエージェントを作成
    - A2A（Agent-to-Agent）プロトコルでの賢者間通信を実装
    - 質問の分析と賢者への委託ロジックを構築
    - **🤖 AI可読性**: オーケストレーションパターンと通信プロトコルを詳細解説
    - _要件: 1.1, 1.2_

  - [x] 2.2 MAGI投票システムの実装 **[🤖 Kiro]**
    - 各賢者からの可決/否決判断を収集する機能を実装
    - 投票結果の集計ロジック（可決票、否決票、棄権票）を構築
    - SOLOMONの最終判断ルール（多数決、詳細分析）を実装
    - _要件: 1.1, 1.2_

  - [x] 2.3 従来機能との統合 **[🤖 Kiro]**
    - 詳細回答内容の生成と構造化を実装
    - 0-100点スコアリングシステムを維持
    - 可決/否決判断と詳細分析の両方を含む応答形式を構築
    - _要件: 1.1, 1.2_

- [ ] 3. Strands Agents 1.0統合とAgentCore Runtime接続 **[🤖 Kiro]**
  - [ ] 3.1 Strands Agents 1.0への移行 **[🤖 Kiro]**
    - Strands Agents 1.0の最新機能（Durable Sessions、Native Async）を実装
    - Agents-as-Tools パターンでSOLOMONが3賢者を制御する構造に更新
    - A2A（Agent-to-Agent）プロトコル対応の実装
    - セッション永続化とコンテキスト管理の実装
    - _要件: 1.1, 1.2, 4.1_

  - [ ] 3.2 AgentCore Runtime統合 **[🤖 Kiro]**
    - Amazon Bedrock AgentCore Runtime（2025年プレビュー版）との統合
    - AgentCore Observability機能の有効化
    - エージェント実行の並列化とリソース管理を実装
    - タイムアウト処理と実行制限の設定
    - _要件: 2.1, 2.2_

  - [ ] 3.3 AWS Distro for OpenTelemetry (ADOT) 統合 **[🤖 Kiro]**
    - ADOT SDKの設定とトレーサーの初期化
    - W3C Trace Context対応のトレースID生成・伝播
    - エージェント実行の各ステップでのスパン作成
    - カスタムメトリクス（実行時間、トークン使用量、エラー率）の定義
    - CloudWatch Application Signals + AWS X-Rayへのエクスポート設定
    - _要件: 2.2, 2.3, 2.4_
    - UI → Gateway → AgentCore → Strands Agentsの一連のトレース連携
    - トレースコンテキストの適切な管理と引き継ぎ
    - _要件: 2.2, 2.3, 2.4_

---

## Phase 1.5: フロントエンド基盤実装

- [ ] 1.5. Next.js 15 + TypeScript フロントエンド実装 **[🤖 Kiro]**
  - [ ] 1.5.1 MAGIチャットインターフェースの実装 **[🤖 Kiro]**
    - チャット画面の基本レイアウト実装
    - メッセージ送信・表示機能の実装
    - エージェント応答の可決/否決表示（視覚的に分かりやすく）
    - リアルタイム更新機能の実装
    - _要件: 1.1, 1.3_

  - [ ] 1.5.2 エージェント状態表示の実装 **[🤖 Kiro]**
    - 3賢者の実行状態表示（thinking, completed, error）
    - SOLOMON Judgeの統合評価表示
    - 投票結果の視覚的表示（可決/否決票数）
    - 確信度とスコアの表示
    - アクセシビリティ対応（色だけでなくアイコンも使用）
    - _要件: 1.2, 1.3_

  - [ ] 1.5.3 トレース表示機能の実装 **[🤖 Kiro]**
    - 実行ステップのリアルタイム表示
    - トレースIDによる実行追跡
    - エラー状況の詳細表示
    - パフォーマンスメトリクスの表示
    - _要件: 2.2, 3.1, 3.2_

  - [ ] 1.5.4 会話履歴管理の実装 **[🤖 Kiro]**
    - 会話一覧の表示
    - 会話の検索・フィルタリング機能
    - 会話の削除・エクスポート機能
    - ページネーション対応
    - _要件: 3.4, 3.5_

---

## 📚 Phase 1 完了時の学習資料更新 **[🤖 Kiro]**
- [ ] **学習ドキュメント更新**: Phase 1完了時
  - `docs/learning/phases/agents-phase1/README.md` 新規作成
  - `docs/learning/phases/agents-phase1/strands-agents-setup.md` 新規作成
  - `docs/learning/phases/agents-phase1/magi-orchestration.md` 新規作成
  - `docs/learning/phases/agents-phase1/agentcore-integration.md` 新規作成
  - エージェント設計パターンと実装判断をドキュメント化
  - _学習戦略: マルチエージェントシステム構築の完全ガイド_

---

## Phase 2: Amplify統合とAPI実装

- [ ] 4. Amplify Custom Handlerの有効化と実装 **[🤖 Kiro]**
  - [ ] 4.1 無効化されたハンドラーの有効化 **[🤖 Kiro]**
    - `amplify/functions/agent-gateway-disabled` を `agent-gateway` に変更
    - Amplify Gen2カスタムビジネスロジックハンドラーを有効化
    - TypeScript型定義とリクエスト/レスポンス検証を実装
    - 環境変数管理とAWS認証情報の設定
    - _要件: 1.1, 1.3_

  - [ ] 4.2 AgentCore統合レイヤーの実装 **[🤖 Kiro]**
    - Amplify HandlerからBedrock AgentCore Runtime（2025年版）への接続を実装
    - Strands Agents 1.0ゲートウェイとの通信プロトコルを構築
    - エラーハンドリングとリトライロジックを実装
    - VPC + PrivateLink対応の実装
    - _要件: 1.1, 1.3, 5.3_

  - [ ] 4.3 認証とセキュリティの実装 **[🤖 Kiro]**
    - Amplify Authトークンの検証機能を実装
    - 入力データの検証とサニタイゼーションを追加
    - プロンプトインジェクション攻撃の検出・防止機能を実装
    - _要件: 6.1, 6.2, 6.3_

- [x] 5. TraceStep永続化システムの基盤実装
  - [x] 5.1 Amplify Data統合 **[🤖 Kiro]**
    - TraceStepモデルへの保存機能を実装
    - リアルタイムストリーミング配信の設定
    - バッチ保存とエラー処理の実装
    - _要件: 3.1, 3.2, 3.4_

  - [ ] 5.2 トレースデータの構造化 **[🤖 Kiro]**
    - エージェント実行ステップの要約生成を実装
    - 使用ツール、引用URL、メトリクスの抽出機能を構築
    - 機密情報の除外とデータ匿名化を実装
    - _要件: 3.1, 3.2, 6.4_

  - [ ] 5.3 保存エラー処理とフォールバック **[🤖 Kiro]**
    - 保存失敗時のエラーハンドリングを実装
    - 実行継続のためのフォールバック機構を構築
    - 古いトレースデータの自動削除機能を実装
    - _要件: 3.3, 3.5_

## Phase 3: エラーハンドリングと可用性

- [ ] 6. エージェント実行エラー処理の実装
  - [ ] 6.1 エラー分類と回復戦略
    - エージェント実行エラーの分類システムを実装
    - エラータイプ別の回復戦略を構築
    - 指数バックオフリトライロジックを実装
    - _要件: 5.3, 5.4_

  - [ ] 6.2 段階的機能縮退の実装
    - 一部エージェント失敗時の継続実行機能を実装
    - SOLOMON失敗時の代替評価システムを構築
    - 部分結果での応答生成機能を実装
    - _要件: 5.3, 5.4_

  - [ ] 6.3 フォールバック設定システム
    - デフォルト設定での再実行機能を実装
    - 設定エラー時の自動フォールバックを構築
    - エラー状況の詳細ログ記録を実装
    - _要件: 4.3, 5.4_

- [ ] 7. パフォーマンス最適化の実装
  - [ ] 7.1 並列実行の最適化
    - 3賢者の効率的な並列実行を実装
    - リソース使用量の監視と制御を追加
    - 実行時間の最適化とボトルネック特定を実装
    - _要件: 5.1, 5.2_

  - [ ] 7.2 キャッシュシステムの実装
    - エージェント応答のキャッシュ機能を実装（オプション）
    - キャッシュキー生成とTTL管理を構築
    - キャッシュヒット率の監視機能を追加
    - _要件: 5.1, 5.2_

  - [ ] 7.3 負荷分散とスケーリング
    - 高負荷時の適切なキューイングを実装
    - AgentCoreの自動スケーリング設定を構築
    - 負荷監視とアラート機能を実装
    - _要件: 5.2, 5.5_

## Phase 4: 観測とモニタリング（2025年版）

- [ ] 8. CloudWatch Application Signals統合監視システムの実装
  - [ ] 8.1 Application Signals メトリクス収集の実装 **[🤖 Kiro]**
    - CloudWatch Application Signalsによるエージェント実行メトリクス収集
    - トークン使用量、レイテンシ、エラー率の自動監視
    - カスタムメトリクスのApplication Signals送信を実装
    - SLI/SLO自動計算機能の実装
    - _要件: 2.4, 2.5_

  - [ ] 8.2 統合ダッシュボードとアラート **[🤖 Kiro]**
    - CloudWatch Application Signalsダッシュボードの設計と実装
    - 異常検知とアラート機能を構築（Machine Learning Insights活用）
    - マルチエージェント実行の可視化機能
    - パフォーマンス異常の自動検知とアラート
    - _要件: 2.5_

  - [ ] 8.3 構造化ログとトラブルシューティング **[🤖 Kiro]**
    - CloudWatch Logs Insightsによる構造化ログ実装
    - エラー追跡とデバッグ情報の記録
    - ログ分析とトラブルシューティング支援機能を構築
    - 分散トレーシングとログの相関分析機能
    - _要件: 6.5_

## Phase 5: テストとデプロイメント（最小限実装）

- [ ] 9. 最小限テスト実装
  - [ ]* 9.1 コア機能単体テストの作成 **[🤖 Kiro]**
    - SOLOMON統括機能の基本テスト
    - エラーハンドリングとフォールバック機能のテスト
    - _要件: 1.1, 1.2, 5.3_

  - [ ]* 9.2 E2E統合テストの作成 **[🤖 Kiro]**
    - 完全なMAGI実行フローの統合テスト
    - フロントエンド→API→エージェント→レスポンスの一連のテスト
    - _要件: 1.1, 1.2, 1.3_

  - [ ] 9.3 基本パフォーマンステスト **[🤖 Kiro]**
    - 並列実行の基本動作テスト
    - レスポンス時間の測定とボトルネック特定
    - _要件: 5.1, 5.2_

- [ ] 10. デプロイメントと運用準備（最小限）
  - [ ] 10.1 本番環境設定 **[🤖 Kiro]**
    - 環境変数と機密情報の適切な管理
    - 基本的なセキュリティ設定の実装
    - _要件: 6.1, 6.5_

  - [ ] 10.2 基本CI/CDパイプラインの構築 **[🤖 Kiro]**
    - 自動テストとデプロイメントパイプラインを構築
    - ロールバック機能の基本実装
    - _要件: 5.5_

  - [ ] 10.3 基本運用ドキュメントの作成 **[🤖 Kiro]**
    - システム運用マニュアルの作成
    - 基本的なトラブルシューティングガイドの整備
    - _要件: 全要件_

---

## 🎯 優先実装順序（2025年10月版）

### 最優先（MVP機能）
1. **Phase 1.5**: フロントエンド基盤実装（ユーザーが触れる部分）
2. **Phase 2**: Amplify統合とAPI実装（バックエンド接続）
3. **Phase 3**: エラーハンドリング（基本的な安定性）

### 次優先（本格運用）
4. **Phase 1**: Strands Agents 1.0統合（最新技術対応）
5. **Phase 4**: 観測とモニタリング（運用監視）
6. **Phase 5**: テストとデプロイメント（品質保証）

### 技術更新ポイント（2025年10月）
- **Strands Agents 1.0**: Durable Sessions、Native Async、A2A Protocol
- **Amazon Bedrock AgentCore**: 2025年プレビュー版、Observability機能
- **AWS Distro for OpenTelemetry (ADOT)**: W3C Trace Context、Application Signals
- **CloudWatch Application Signals**: SLI/SLO自動計算、Machine Learning Insights
- **Next.js 15**: 最新のReact Server Components、Streaming
- **アクセシビリティ**: 視覚的に分かりやすいUI、色だけでなくアイコンも併用