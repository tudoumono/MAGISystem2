# 統合要件定義 - MAGI Decision System

## 1. 機能要件

### 1.1 多視点分析システム
- **3賢者による並列分析**
  - CASPAR（保守的・現実的視点）: 実行可能性重視
  - BALTHASAR（革新的・感情的視点）: 倫理と創造性考慮
  - MELCHIOR（バランス型・科学的視点）: データと論理重視
- **並列実行**: 3エージェントの同時実行（逐次実行禁止）
- **A2A通信**: Agent-to-Agentプロトコル対応

### 1.2 MAGI投票システム（新機能）
- **可決/否決判断**: 各賢者からの明確な判断収集
- **投票結果集計**: 可決票、否決票、棄権票の自動集計
- **視覚的表示**: 色分け + アイコンによる判断結果表示
- **判断理由**: 各賢者の判断根拠の詳細表示

### 1.3 SOLOMON統括システム
- **オーケストレーション**: 3賢者の実行制御と結果統合
- **最終判断**: MAGI投票結果に基づく統合判断
- **従来機能維持**: 0-100点スコアリングと詳細分析
- **Judge機能**: 最終的な意思決定支援

### 1.4 リアルタイム機能
- **ライブ更新**: GraphQL Subscriptionsによるリアルタイム表示
- **トレース表示**: 実行ステップのライブ監視
- **状態表示**: エージェント実行状態（thinking, completed, error）
- **進捗表示**: 実行進捗とパフォーマンスメトリクス

### 1.5 会話管理
- **会話履歴**: 永続化された会話データ
- **検索・フィルタ**: 会話の検索とフィルタリング機能
- **エクスポート**: 会話データのエクスポート機能
- **削除管理**: 会話の削除と復元機能

## 2. データ要件

### 2.1 データモデル
```typescript
// 統合データモデル
interface User {
  id: string;
  email: string;
  name: string;
  preferences: UserPreferences;
  createdAt: Date;
  updatedAt: Date;
}

interface Conversation {
  id: string;
  userId: string;
  title: string;
  createdAt: Date;
  updatedAt: Date;
  messages: Message[];
}

interface Message {
  id: string;
  conversationId: string;
  role: 'user' | 'assistant';
  content: string;
  agentResponses?: AgentResponse[];
  judgeResponse?: JudgeResponse;
  magiVoting?: MAGIVotingResult;  // 新機能
  traceId?: string;
  createdAt: Date;
}

interface MAGIVotingResult {  // 新機能
  caspar: VoteDecision;
  balthasar: VoteDecision;
  melchior: VoteDecision;
  finalDecision: 'approved' | 'rejected' | 'abstain';
  confidence: number;
  reasoning: string;
}

interface VoteDecision {
  vote: 'approve' | 'reject' | 'abstain';
  confidence: number;
  reasoning: string;
}

interface TraceStep {
  id: string;
  traceId: string;
  stepNumber: number;
  agentId: string;
  action: string;
  toolsUsed: string[];
  citations: string[];
  duration: number;
  errorCount: number;
  timestamp: Date;
}

interface AgentPreset {
  id: string;
  userId: string;
  name: string;
  description: string;
  agentConfigs: AgentConfig[];
  isDefault: boolean;
  createdAt: Date;
}
```

### 2.2 データ永続化
- **DynamoDB**: メインデータストレージ
- **オーナーベースアクセス**: ユーザー別データ分離
- **リアルタイム同期**: AppSync GraphQL Subscriptions
- **データシーディング**: 2025年新機能活用

### 2.3 データ保護
- **暗号化**: 保存時・転送時の暗号化
- **アクセス制御**: 認証・認可による適切なアクセス制限
- **データ匿名化**: 機密情報の適切な処理
- **GDPR対応**: プライバシー規制への準拠

## 3. エージェント要件

### 3.1 Strands Agents 1.0統合
- **Durable Sessions**: セッション永続化とコンテキスト管理
- **Native Async**: 非同期処理とパフォーマンス最適化
- **Agents-as-Tools**: SOLOMONが3賢者を制御する構造
- **A2A Protocol**: Agent-to-Agent通信プロトコル

### 3.2 Amazon Bedrock統合
- **Multi-Agent Collaboration**: 2025年GA版機能活用
- **Supervisor Agent**: SOLOMON統括エージェント
- **Sub-Agents**: 3賢者エージェント
- **Inline Agents**: インライン処理とPayload Referencing

### 3.3 エージェント設定管理
- **プリセットシステム**: デフォルト、学術研究、ビジネス分析用設定
- **動的設定変更**: 会話途中での設定変更機能
- **設定比較**: 設定差分の可視化機能
- **インポート/エクスポート**: 設定の共有機能

### 3.4 エラーハンドリング
- **段階的機能縮退**: 一部エージェント失敗時の継続実行
- **フォールバック機構**: 代替実行パスの提供
- **エラー分類**: エラータイプ別の適切な対応
- **回復戦略**: 自動回復とユーザー通知

### 3.5 再実行・比較機能
- **再質問機能**: 同一質問の再実行と結果比較
- **応答履歴**: バージョン管理と履歴表示
- **評価機能**: 応答品質の評価とフィードバック
- **A/Bテスト**: 設定比較とパフォーマンス測定

## 4. 観測・監視要件

### 4.1 分散トレーシング
- **OpenTelemetry統合**: W3C Trace Context対応
- **エンドツーエンドトレース**: UI → Gateway → AgentCore → Strands Agents
- **トレースID伝播**: 全システム間での一貫したトレース
- **スパン管理**: 適切なスパン作成と管理

### 4.2 メトリクス収集
- **カスタムメトリクス**: エージェント実行時間、トークン使用量、エラー率
- **ビジネスメトリクス**: 会話数、エージェント実行数、ユーザーエンゲージメント
- **パフォーマンスメトリクス**: レスポンス時間、スループット、リソース使用量
- **セキュリティメトリクス**: 認証失敗、異常アクセス、セキュリティイベント

### 4.3 CloudWatch Application Signals統合
- **SLI/SLO自動計算**: サービスレベル指標の自動監視
- **Machine Learning Insights**: 異常検知とパターン分析
- **自動アラート**: 閾値ベースとML基準のアラート
- **ダッシュボード**: 統合監視ダッシュボード

### 4.4 ログ管理
- **構造化ログ**: JSON形式の統一ログフォーマット
- **ログ集約**: CloudWatch Logs Insightsによる分析
- **ログ相関**: トレースIDによるログとトレースの相関
- **ログ保持**: 適切な保持期間とアーカイブ戦略

### 4.5 アラートとインシデント管理
- **階層化アラート**: Warning、Critical、Emergency
- **自動エスカレーション**: オンコール体制との統合
- **インシデント対応**: 自動化された対応プロシージャ
- **ポストモーテム**: 根本原因分析と改善計画

### 4.6 リアルタイム監視
- **ライブダッシュボード**: リアルタイムシステム状況表示
- **実行監視**: エージェント実行のライブ監視
- **パフォーマンス監視**: レスポンス時間とリソース使用量
- **ユーザー体験監視**: フロントエンドパフォーマンス

## 5. セキュリティ要件

### 5.1 認証・認可
- **多要素認証**: SMS、TOTP対応
- **ソーシャルログイン**: Google、Apple統合
- **セッション管理**: 適切なタイムアウトと更新
- **権限管理**: ロールベースアクセス制御

### 5.2 データセキュリティ
- **暗号化**: AES-256による保存時暗号化
- **TLS**: 転送時暗号化の強制
- **キー管理**: AWS KMSによる暗号化キー管理
- **データマスキング**: 機密情報の適切な処理

### 5.3 基本ネットワークセキュリティ
- **HTTPS**: Amplify標準のHTTPS設定
- **セキュリティグループ**: 基本的なアクセス制御
- **プライベート通信**: Amplify内部通信の活用
- **基本認証**: Cognito標準セキュリティ機能

### 5.4 アプリケーションセキュリティ
- **入力検証**: SQLインジェクション、XSS対策
- **プロンプトインジェクション**: AI特有の攻撃対策
- **レート制限**: API呼び出し頻度制限
- **監査ログ**: 全操作の記録と監視

### 5.5 コンプライアンス
- **GDPR**: EU一般データ保護規則対応
- **CCPA**: カリフォルニア州消費者プライバシー法対応
- **SOC2**: セキュリティ統制の実装
- **監査証跡**: コンプライアンス監査対応

## 6. 運用要件

### 6.1 デプロイメント
- **Infrastructure as Code**: Amplify Gen2による設定管理
- **Amplify Hosting**: 自動CloudFront統合デプロイメント
  - `npx ampx push` による手動デプロイ（学習目的）
  - CloudFrontが自動的に設定・有効化される
  - グローバルCDNによる高速配信が標準で利用可能
- **環境管理**: 開発環境中心の構成（学習用）
- **基本CI/CD**: 手動デプロイによる理解促進

### 6.2 可用性
- **高可用性**: 99.5%以上のシステム稼働率
- **災害復旧**: マルチリージョン対応
- **バックアップ**: 自動バックアップと復元
- **フェイルオーバー**: 自動フェイルオーバー機能

### 6.3 基本スケーラビリティ
- **サーバーレス**: Lambda/DynamoDBの自動スケール活用
- **オンデマンド**: DynamoDBオンデマンド課金モード
- **基本キャッシュ**: ブラウザキャッシュとローカルストレージ
- **Amplify Hosting**: 自動CloudFront統合によるCDN機能
  - Amplify Hostingのデフォルト設定でCloudFrontが自動有効化
  - グローバルエッジロケーションによる高速配信
  - 必要に応じてAmplify Console設定で調整可能

### 6.4 保守性
- **監視**: 包括的な監視とアラート
- **ログ**: 詳細なログ記録と分析
- **ドキュメント**: 運用マニュアルと手順書
- **トレーニング**: 運用チーム向けトレーニング

### 6.5 基本コスト管理
- **無料枠活用**: AWS無料利用枠の最大活用
- **手動監視**: AWS Billing Dashboardでの基本監視
- **リソース削除**: 不要リソースの手動削除
- **シンプル構成**: コスト効率の良いシンプルな構成

## 7. パフォーマンス要件

### 7.1 レスポンス時間
- **初回応答**: 2秒未満（エージェント応答開始まで）
- **UI操作**: 100ms未満（全ユーザー操作）
- **データ取得**: 500ms未満（会話履歴等）
- **リアルタイム更新**: 100ms未満（WebSocket通信）

### 7.2 基本スループット
- **同時ユーザー**: 10ユーザー同時接続対応（個人学習用）
- **エージェント実行**: 5並列実行対応
- **API呼び出し**: 100 req/min対応
- **データベース**: 50 TPS対応

### 7.3 リソース使用量
- **メモリ使用量**: 効率的なメモリ管理
- **CPU使用率**: 80%未満の維持
- **ネットワーク**: 帯域幅の効率的利用
- **ストレージ**: 適切なデータ圧縮と最適化

### 7.4 基本可用性目標
- **システム稼働率**: 95%以上（学習用として十分）
- **平均復旧時間**: 手動復旧対応
- **基本的な安定性**: 通常使用での安定動作
- **データ整合性**: 基本的なデータ保護

### 7.5 学習用コスト効率
- **月間運用コスト**: AWS無料枠内での運用
- **シンプル構成**: 学習に必要な最小構成
- **手動管理**: 手動でのリソース管理
- **コスト意識**: 基本的なAWSコスト理解

## 8. ユーザビリティ要件

### 8.1 アクセシビリティ
- **WCAG 2.1 AA準拠**: Webアクセシビリティガイドライン準拠
- **キーボードナビゲーション**: 全機能のキーボード操作対応
- **スクリーンリーダー**: 適切なARIAラベルとセマンティックHTML
- **色覚対応**: 色だけでなくアイコンも併用した視覚的手がかり

### 8.2 多言語対応
- **日本語最適化**: 日本語UI/UXパターンの適用
- **フォント最適化**: 日本語フォントとタイポグラフィ
- **文字エンコーディング**: UTF-8による適切な文字処理
- **ローカライゼーション**: 日本語特有の表現と慣習

### 8.3 レスポンシブデザイン
- **マルチデバイス**: デスクトップ、タブレット、モバイル対応
- **ブレークポイント**: 適切なレスポンシブブレークポイント
- **タッチ操作**: モバイルデバイスでの快適な操作
- **パフォーマンス**: デバイス別の最適化

### 8.4 ユーザーエクスペリエンス
- **直感的操作**: 学習コストの低いインターフェース
- **視覚的フィードバック**: 操作結果の明確な表示
- **エラーハンドリング**: ユーザーフレンドリーなエラーメッセージ
- **ヘルプ機能**: コンテキストヘルプとチュートリアル