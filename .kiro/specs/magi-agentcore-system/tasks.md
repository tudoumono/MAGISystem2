# MAGI Decision System - AgentCore Runtime実装タスク

## 🎯 実装戦略

AWS公式の`bedrock-agentcore-starter-toolkit`を使用して、MAGI Decision SystemをAmazon Bedrock AgentCore Runtime上に段階的に実装します。

**注意**: この実装は既存のLambda版実装を置き換え、より高性能で保守しやすいAgentCore Runtime版に統合します。

---

## Phase 1: AgentCore Runtime基盤構築

### 1. 開発環境セットアップ

- [ ] 1.1 AgentCore開発環境の構築
  - Python 3.11+ 仮想環境の作成
  - bedrock-agentcore、strands-agents、bedrock-agentcore-starter-toolkitのインストール
  - AWS認証情報の設定（ap-northeast-1リージョン）
  - Claude 3.5 Sonnetモデルアクセスの有効化
  - _要件: 1.1, 1.2, 1.3_

- [ ] 1.2 基本エージェント実装
  - `magi_agent.py`の作成（BedrockAgentCoreApp使用）
  - Strands Agentsの基本統合
  - エントリーポイント関数の実装
  - `requirements.txt`の作成
  - _要件: 2.1, 2.2_

- [ ] 1.3 ローカル動作確認
  - ローカルエージェントサーバーの起動（ポート8080）
  - curlによる基本動作テスト
  - レスポンス形式の確認
  - エラーハンドリングの基本実装
  - _要件: 1.4, 2.4_

### 2. AgentCore Runtime設定・デプロイ

- [ ] 2.1 AgentCore設定
  - `agentcore configure`による設定ファイル生成
  - ap-northeast-1リージョンの指定
  - `.bedrock_agentcore.yaml`設定の最適化
  - メモリ・タイムアウト設定（2GB、8分）
  - _要件: 1.1, 1.3_

- [ ] 2.2 初回デプロイ実行
  - `agentcore launch`によるデプロイ
  - ECRリポジトリ、IAMロール、CloudWatchログの自動作成
  - Agent ARNの取得・記録
  - デプロイ成功の確認
  - _要件: 1.3, 4.1_

- [ ] 2.3 デプロイ済みエージェントテスト
  - `agentcore invoke`による動作確認
  - AWS SDK（boto3）による呼び出しテスト
  - セッション管理の動作確認
  - エラーケースのテスト
  - _要件: 1.5, 3.4_

---

## Phase 2: MAGI Decision System実装

### 3. 3賢者エージェント実装

- [ ] 3.1 CASPAR（保守的賢者）実装
  - 保守的・現実的視点のシステムプロンプト作成
  - リスク重視の判断ロジック実装
  - JSON形式レスポンスの実装
  - エラーハンドリングとフォールバック
  - _要件: 2.1, 2.2_

- [ ] 3.2 BALTHASAR（革新的賢者）実装
  - 革新的・感情的視点のシステムプロンプト作成
  - 創造性重視の判断ロジック実装
  - JSON形式レスポンスの実装
  - エラーハンドリングとフォールバック
  - _要件: 2.1, 2.2_

- [ ] 3.3 MELCHIOR（バランス型賢者）実装
  - バランス型・科学的視点のシステムプロンプト作成
  - 論理性重視の判断ロジック実装
  - JSON形式レスポンスの実装
  - エラーハンドリングとフォールバック
  - _要件: 2.1, 2.2_

### 4. SOLOMON Judge統合評価実装

- [ ] 4.1 SOLOMON Judge基本実装
  - 統括者システムプロンプトの作成
  - 3賢者判断の統合ロジック実装
  - 投票結果集計機能（可決/否決/棄権）
  - 0-100点スコアリング機能
  - _要件: 2.3, 2.4_

- [ ] 4.2 並列実行・統合処理
  - asyncioによる3賢者並列実行
  - 実行時間測定とパフォーマンス最適化
  - 段階的機能縮退（エージェント失敗時）
  - 最終レスポンス形式の統一
  - _要件: 2.2, 2.5_

### 5. 高度な機能実装

- [ ] 5.1 セッション管理・コンテキスト保持
  - セッションIDによる会話継続
  - コンテキスト情報の管理
  - 長時間セッション（8時間）の活用
  - セッション分離の確認
  - _要件: 3.5, 1.5_

- [ ] 5.2 エラーハンドリング・復旧機能
  - 個別エージェント失敗時の処理
  - 部分的結果による継続処理
  - 自動リトライ機構
  - 詳細エラーログ出力
  - _要件: 2.5, 4.3_

---

## Phase 3: フロントエンド統合

### 6. Next.js API統合

- [ ] 6.1 AgentCore Runtime API統合
  - BedrockAgentCoreClientの実装
  - InvokeAgentRuntimeCommandの統合
  - ストリーミング応答の処理
  - エラーハンドリングとフォールバック
  - _要件: 3.1, 3.2_

- [ ] 6.2 API Routeの実装
  - `/api/agents/ask`エンドポイント作成
  - リクエスト・レスポンス形式の統一
  - 認証・認可の実装
  - CORS設定とセキュリティ
  - _要件: 3.1, 3.4, 5.1_

- [ ] 6.3 フロントエンドUI更新
  - 既存MAGIデザインシステムの活用（consolidated-magi-systemから移行）
  - AgentCore Runtime対応のステータス表示
  - リアルタイム更新機能の調整
  - エラー表示の改善
  - 既存Lambda実装からの段階的移行
  - _要件: 3.3, 3.4_

### 7. エンドツーエンド統合テスト

- [ ] 7.1 統合動作確認
  - UI → API → AgentCore Runtime → MAGI Agentsの完全フロー
  - 複数セッション同時実行テスト
  - 長時間セッションテスト
  - エラーケース・復旧テスト
  - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 7.2 パフォーマンステスト
  - 応答時間測定（目標: 初回3秒、並列5秒）
  - 同時セッション数テスト
  - リソース使用量監視
  - スケーラビリティ確認
  - _要件: 1.4, 1.5_

---

## Phase 4: 監視・運用機能

### 8. 監視・ログ機能実装

- [ ] 8.1 CloudWatch統合
  - 詳細ログ出力の実装
  - カスタムメトリクスの定義
  - アラート設定
  - ダッシュボード作成
  - _要件: 4.1, 4.2, 4.3_

- [ ] 8.2 AgentCore Observability設定
  - トレーシング機能の有効化
  - パフォーマンス監視の設定
  - エラー追跡の実装
  - 監視データの可視化
  - _要件: 4.4, 4.5_

### 9. セキュリティ・権限管理

- [ ] 9.1 IAM権限最適化
  - 最小権限の原則適用
  - AgentCore Runtime専用ロール作成
  - Bedrock API権限の設定
  - セキュリティポリシーの実装
  - _要件: 5.1, 5.2, 5.5_

- [ ] 9.2 セキュリティ監査・テスト
  - 権限設定の検証
  - セッション分離の確認
  - データ暗号化の検証
  - セキュリティログの確認
  - _要件: 5.3, 5.4_

---

## Phase 5: 本番運用準備

### 10. CI/CD・自動化

- [ ] 10.1 GitHub Actions CI/CD構築
  - 自動テスト・デプロイパイプライン
  - AgentCore Runtime自動デプロイ
  - 環境別設定管理
  - ロールバック機能
  - _要件: 実装効率化_

- [ ] 10.2 運用自動化
  - ヘルスチェック機能
  - 自動スケーリング設定
  - バックアップ・復旧手順
  - 監視アラート自動化
  - _要件: 運用効率化_

### 11. ドキュメント・学習資料

- [ ] 11.1 技術ドキュメント更新
  - AgentCore Runtime対応のアーキテクチャ図
  - API仕様書の更新
  - デプロイ手順書の作成
  - トラブルシューティングガイド
  - _要件: 保守性向上_

- [ ] 11.2 学習・運用ガイド作成
  - AgentCore Runtime学習ガイド
  - MAGI Decision System運用マニュアル
  - パフォーマンスチューニングガイド
  - セキュリティベストプラクティス
  - _要件: 学習効果最大化_

---

## 📊 実装優先度と推定時間

### 最優先（Phase 1-2）: 基本機能実装
- **推定時間**: 4-6時間
- **成果物**: 動作するMAGI Decision System on AgentCore Runtime

### 次優先（Phase 3）: フロントエンド統合
- **推定時間**: 2-3時間  
- **成果物**: エンドツーエンド動作確認

### その後（Phase 4-5）: 運用・監視強化
- **推定時間**: 3-4時間
- **成果物**: 本番運用可能なシステム

---

## 🎯 成功基準

### 技術的成功基準
1. ✅ AgentCore Runtime上でMAGI Decision Systemが動作
2. ✅ 3賢者 + SOLOMON Judgeによる統合判断が機能
3. ✅ フロントエンドからの呼び出しが成功
4. ✅ 8時間の長時間セッションが利用可能
5. ✅ 専用マイクロVMによるセッション分離が実現

### 学習効果基準
1. ✅ AWS公式ツールの実践的活用
2. ✅ AgentCore Runtimeの理解と習得
3. ✅ Strands Agentsの高度な活用
4. ✅ 企業レベルのAIシステム構築経験
5. ✅ 最新AWS AI/MLサービスの実践経験

この実装計画により、AWS公式ツールを使用した最新かつ確実なMAGI Decision Systemが構築されます。