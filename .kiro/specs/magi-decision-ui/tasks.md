# 実装計画

## 開発アプローチ: フロントエンドファースト

### 🎯 **段階的開発戦略**
**Phase 1-2**: モックデータでUI完成 → **Phase 3**: 部分統合 → **Phase 4-6**: 完全統合

### 📊 **各Phaseの動作レベル**
- **Phase 1-2**: 完全モック（視覚的に完璧、学習効果最大）
- **Phase 3**: 認証・データは実データ、エージェントはモック
- **Phase 4-6**: 全て実データ（本格的MAGIシステム）

### 🎓 **学習メリット**
- 視覚的フィードバックでモチベーション維持
- 段階的複雑性で自然な学習曲線
- エラーが分かりやすく、デバッグが容易

---

## 📋 AWS MCP参照タスク（継続的実施）

- [x] **AWS MCP継続参照**: 2025年最新情報の確認と反映 **[🤖 Kiro]**
  - **2025年新機能**: Amplify Gen2 TypeScript Data client for Lambda（2025年1月GA）、データシーディング機能
  - **Bedrock Multi-Agent Collaboration GA**: 2025年3月にGA、Inline Agents、Payload Referencing
  - **権限管理**: 最新のIAM権限要件とセキュリティベストプラクティス
  - **コスト最適化**: 2025年料金体系とSkew Protection等の新機能
  - **手順書更新**: 最新機能に基づく実装手順の更新完了
  - _学習戦略: 2025年最新のAWS機能を活用した実装_

---

## Phase 1: 基盤とモックデータ実装

- [x] 1. プロジェクト構造とコアインターフェースのセットアップ **[🤖 Kiro]**
  - Next.js 15 + TypeScript + Tailwind CSSプロジェクトを作成（学習用詳細コメント付き）
  - Amplify Gen2設定（認証、データ、関数）をセットアップ（各設定の説明コメント付き）
  - エージェント、会話、トレース用のコアTypeScriptインターフェースを定義（型設計の理由を説明）
  - ESLint、Prettier、開発ツールを設定（設定理由と最適化ポイントを記載）
  - 学習用README.mdを作成（技術スタックの選択理由と学習ポイントを記載）
  - **モックデータライブラリの基盤を構築（様々なシナリオ対応）**
  - **📚 学習資料: 基礎技術の学習ドキュメント作成完了**
  - _要件: 1.1, 1.2, 1.3_

- [x] 2. データモデルとAmplify Data設定の作成
  - [x] 2.1 Amplify Dataスキーマの定義 **[🤖 Kiro]**
    - User、Conversation、Message、TraceStep、AgentPresetモデルを作成
    - オーナーベースアクセスで認可ルールを設定
    - リアルタイム更新用GraphQLサブスクリプションをセットアップ
    - **🤖 AI可読性**: 各モデルの設計理由と関係性を詳細コメント化
    - _要件: 2.1, 2.2, 2.3_

  - [x] 2.2 TypeScript型とAPIクライアントの生成 **[🤖 Kiro]**
    - Amplify Data型定義の手動作成（学習用詳細コメント付き）
    - データ操作用カスタムフック（useConversations、useMessages）を作成
    - より良いUXのための楽観的更新を実装
    - モッククライアントによるPhase 1-2開発環境の構築
    - **🤖 AI可読性**: 各フックの使用目的と実装パターンを詳細解説
    - _要件: 2.1, 2.2, 2.3_

  - [x] 2.3 実際のAmplify Dataデプロイと統合準備 **[👤 Human + 🤖 Kiro]**





    - **[👤 Human]** `npx ampx push` でAWSリソースを実際にデプロイ
    - **[🤖 Kiro]** 実際のAmplify clientへの切り替え準備
    - **[🤖 Kiro]** 環境変数による開発/本番環境の切り替え設定
    - **[🤖 Kiro]** データシーディング機能の活用（2025年新機能）
    - _要件: 2.1, 2.2, 2.3_

- [x] 3. エージェントゲートウェイとStrands Agents統合
  - [x] 3.1 Strands Agents基本セットアップ **[🤖 Kiro]**
    - 3賢者（CASPAR、BALTHASAR、MELCHIOR）エージェントを作成
    - SOLOMON Judgeエージェントを実装
    - A2A（Agent-to-Agent）プロトコルでの通信を設定
    - _要件: 3.1, 3.2_

- [x] 4. 基本UIコンポーネントライブラリの作成 **[🤖 Kiro]**
  - Next.js 15 + React 19 + Tailwind CSSの基本構成完了
  - レスポンシブデザインとアクセシビリティ対応の基盤構築
  - MAGI風デザインシステムの色彩設計完了
  - **🤖 AI可読性**: デザインシステムの設計原則と各コンポーネントの使用指針を明記
  - _要件: 6.1, 6.2, 6.5_

- [x] 5. モックデータライブラリの実装 **[🤖 Kiro]**
  - 様々なシナリオ（全員一致、意見分裂、エラー）のモックデータを作成完了
  - リアルな応答時間をシミュレートする機能を実装完了
  - エージェント応答とSOLOMON判断のモックデータを生成完了
  - トレースステップのモックデータを作成完了
  - **モックから実データへの移行を容易にする設計完了**
  - ローカルストレージによるデータ永続化実装完了
  - _要件: 3.1, 3.2, 3.3, 3.4_

---

## Phase 2: フロントエンド基盤（認証とデザインシステム）

- [x] 6. 認証UIとデザインシステムの構築





  - [x] 6.1 認証UIコンポーネントの構築 **[🤖 Kiro]**


    - SignInForm、SignUpForm、ForgotPasswordFormコンポーネントを作成
    - SSRトークン処理付きAuthProviderコンテキストを実装
    - 保護されたルートラッパーと認証ガードを構築
    - Next.js 15 App Router + React 19の最新機能活用
    - **🤖 AI可読性**: 各コンポーネントの責務と認証フローを詳細解説
    - _要件: 1.1, 1.2, 1.3_

  - [x] 6.2 SSRセッション管理の実装 **[🤖 Kiro]**


    - リクエストCookieからのトークン検証用サーバーアクションを作成
    - セッション永続化と自動更新を実装
    - 適切なクリーンアップ付きサインアウト機能を追加
    - Next.js 15のServer Actionsとの統合
    - _要件: 1.2, 1.3, 1.4_

- [ ] 7. エージェント応答インターフェースの構築（モックデータ使用）
  - [ ] 7.1 エージェント応答パネルの作成（従来機能 + MAGI判断）
    - 3賢者それぞれのAgentResponsePanelを構築（従来機能）
    - 詳細な回答内容の表示（従来機能）
    - 応答比較とサイドバイサイドビューを追加（従来機能）
    - 可決/否決判断を視覚的に強調表示（色分け、アイコン）（新機能）
    - 判断理由と根拠の詳細表示機能を実装（新機能）
    - スケルトンコンポーネント付きローディング状態を実装
    - **モックデータで様々なシナリオ（全員一致、意見分裂、エラー）をテスト**
    - _要件: 3.1, 3.2, 5.3_

  - [ ] 7.2 SOLOMON Judge統合の実装（Multi-Agent Collaboration対応）
    - スコア可視化付きJudgeResponsePanelを作成
    - Rechartsを使用したスコア比較チャートを構築
    - 信頼度指標付き最終推奨表示を追加
    - MAGI投票結果の集計表示（可決X票、否決Y票）を実装（新機能）
    - SOLOMONの最終判断表示（可決/否決 + 根拠）を構築（新機能）
    - エヴァンゲリオン風のMAGIシステムUIデザインを適用（新機能）
    - 2025年GA版Multi-Agent Collaborationパターンに対応
    - _要件: 3.3, 3.4_

- [ ] 8. 会話管理インターフェースの構築
  - [ ] 8.1 会話サイドバーコンポーネントの作成 **[🤖 Kiro]**
    - 無限スクロール付きConversationSidebarを実装
    - デバウンス入力付き検索機能を追加
    - 会話作成・削除機能を作成
    - _要件: 2.1, 2.2, 2.4, 2.5_

  - [ ] 8.2 会話ビューとメッセージ表示の実装 **[🤖 Kiro]**
    - メッセージ履歴付きChatInterfaceコンポーネントを構築
    - ユーザーとアシスタント用MessageBubbleコンポーネントを作成
    - 会話タイトル編集とメタデータ表示を追加
    - _要件: 2.3, 2.6_

- [ ] 9. 推論トレース可視化の実装
  - [ ] 9.1 トレースステップコンポーネントの作成
    - 展開可能詳細付きTraceStepItemを構築
    - ツール使用と引用表示を実装
    - 実行時間とエラー回数の可視化を追加
    - _要件: 4.1, 4.2, 4.3, 4.6_

  - [ ] 9.2 リアルタイムトレース更新の構築
    - ライブトレース更新用WebSocket接続を実装
    - 到着時の段階的トレースステップレンダリングを作成
    - トレース完了状態と進行状況インジケーターを追加
    - _要件: 4.1, 4.2, 4.6_

---

## Phase 3: コア機能実装（エージェント連携）

- [ ] 10. 実際のAmplify Data統合とリアルタイム機能 **[🤖 Kiro + 👤 Human]** *(Phase 2完了後に実施)*
  - [ ] 10.1 Amplify Data実環境への切り替え **[🤖 Kiro + 👤 Human]** *(準備完了・Phase 2後に有効化)*
    - **[🔄 👤 Human]** AWS環境でのAmplify Dataデプロイ実行 - 準備完了（一時的に無効化中）
    - **[🔄 🤖 Kiro]** モッククライアントから実クライアントへの切り替え - 実装完了（Phase 2後に有効化）
    - **[🔄 🤖 Kiro]** 環境変数による開発/本番環境の自動切り替え - 実装完了（現在はMOCK強制）
    - **[🔄 🤖 Kiro]** データシーディング機能による初期データ投入 - 実装完了（Phase 2後に使用）
    - **[🔄 🤖 Kiro]** 環境ステータス表示コンポーネント - 実装完了（現在はMOCK表示）
    - _要件: 2.1, 2.2, 2.3_ 🔄 **準備完了（Phase 2後に有効化）**
    - _**注記**: 正しい順序での実装のため、Phase 2完了まで一時的に無効化_

  - [ ] 10.2 リアルタイム機能の実装 **[🤖 Kiro]**
    - GraphQL Subscriptionsによるリアルタイム会話更新
    - 楽観的更新と実データ同期の統合
    - エラーハンドリングとオフライン対応の強化
    - パフォーマンス最適化（仮想スクロール等）
    - _要件: 2.4, 2.5, 2.6_
    - _**前提**: Phase 2完了後、10.1の有効化と同時に実施_

- [ ] 11. Amazon Bedrock Multi-Agent Collaboration統合（2025年GA版） **[👤 Human + 🤖 Kiro]**
  - **[👤 Human]** IAMユーザーに `AmazonBedrockFullAccess` 権限を追加
  - **[� Hu1man]** AWS ConsoleでBedrock モデルアクセス権限を有効化
  - **[👤 Human]** Bedrock Multi-Agent Collaborationの設定
  - **[🤖 Kiro]** Supervisor Agent（SOLOMON）の実装
  - **[🤖 Kiro]** Sub-Agents（3賢者）の実装と連携
  - **[🤖 Kiro]** Inline AgentsとPayload Referencingの活用
  - **[🤖 Kiro]** カスタムAmplifyハンドラーの構築
  - **[🤖 Kiro]** Bedrock統合用カスタムビジネスロジックハンドラーを作成
  - **[🤖 Kiro]** エージェントオーケストレーションと応答集約を実装
  - _要件: 3.1, 3.2, 3.3, 4.5_

- [ ] 12. エージェント設定とプリセットシステムの実装
  - [ ] 12.1 エージェント設定コンポーネントの作成 **[🤖 Kiro]**
    - 個別エージェント設定用AgentConfigPanelを構築
    - モデル選択、プロンプト編集、パラメータ調整を実装
    - プリセット管理インターフェース（作成、編集、削除、複製）を作成
    - _要件: 7.1, 7.2, 7.3_

  - [ ] 12.2 デフォルト設定付きプリセットシステムの実装 **[🤖 Kiro]**
    - デフォルトプリセット（デフォルト、学術研究用、ビジネス分析用）を作成
    - プリセット選択ドロップダウンとプレビュー機能を構築
    - プリセットインポート/エクスポート機能を実装
    - _要件: 7.2, 7.3, 7.4_

- [ ] 13. 動的機能とエラーハンドリング
  - [ ] 13.1 動的設定切り替えの追加
    - 会話途中での設定変更を実装
    - 設定変更通知と確認を作成
    - 設定比較と差分可視化を追加
    - _要件: 7.5, 7.6_

  - [ ] 13.2 再実行と比較機能の追加
    - 結果比較付き「再質問」機能を実装
    - 応答履歴とバージョン比較を作成
    - 応答評価とフィードバック収集を追加
    - _要件: 3.5, 7.6_

  - [ ] 13.3 エラーハンドリングとフォールバック機構の追加
    - 包括的エラーバウンダリシステムを実装
    - ユーザーフレンドリーなエラーメッセージと回復オプションを作成
    - オフラインサポートとリクエストキューイングを追加
    - _要件: 5.5_

---

## 🔄 Phase 2完了後の移行手順

**Phase 2のUI実装完了後、以下の手順でPhase 3に移行:**

1. **MOCKモード強制を解除**
   ```typescript
   // src/lib/amplify/config.ts
   const FORCE_MOCK_UNTIL_PHASE2_COMPLETE = false; // true → false に変更
   ```

2. **環境ステータスの確認**
   - 🔧 **Development Mode** に自動切り替え
   - ☁️ **Connected** 状態の確認

3. **Phase 3タスク10.1の有効化**
   - 実際のAWS接続開始
   - データシーディング実行
   - リアルタイム機能の統合

4. **動作確認**
   - 認証: 実際のCognito認証
   - データ: 実際のDynamoDB保存
   - UI: Phase 2で実装したコンポーネント

---

## Phase 4: パフォーマンス最適化とアクセシビリティ

- [ ] 14. パフォーマンス最適化と高度な機能
  - [ ] 14.1 コード分割と遅延読み込みの追加
    - Next.js 15でルートベースコード分割を実装
    - 重いコンポーネントのコンポーネント遅延読み込みを追加
    - 動的インポートでバンドルサイズを最適化
    - _要件: 5.1, 5.2_

  - [ ] 14.2 キャッシュと最適化戦略の実装
    - APIレスポンスキャッシュ用React Queryを追加
    - 会話リスト用仮想スクロールを実装
    - 画像最適化とアセット圧縮を追加
    - _要件: 5.1, 5.4_

- [ ] 15. アクセシビリティと国際化の追加（ユーザーフレンドリー重視）
  - [ ] 15.1 WCAG 2.1 AA準拠の実装（視覚的分かりやすさ重視）
    - 適切なARIAラベルとセマンティックHTMLを追加
    - 全コンポーネントのキーボードナビゲーションを実装
    - スクリーンリーダーサポートとアナウンスを追加
    - 色覚特性対応（色以外の視覚的手がかりを併用）
    - 高コントラスト対応とフォーカス表示の強化
    - _要件: 6.1, 6.2_

  - [ ] 15.2 日本語対応の強化（i18nライブラリは使用せず）
    - 日本語ラベルの定数管理とUI表示の最適化
    - 日本語フォントとタイポグラフィの調整
    - 日本語特有のUI/UXパターンの適用
    - _要件: 6.3, 6.4_

- [ ] 16. 最小限のテスト実装
  - [ ]* 16.1 コア機能の単体テスト作成 **[🤖 Kiro]**
    - 重要なフック（useConversations、useMessages）のテスト
    - エージェント応答処理のテスト
    - エラーハンドリングのテスト
    - _要件: 2.1, 2.2, 2.3_

  - [ ]* 16.2 E2Eテストの最小実装 **[🤖 Kiro]**
    - 基本的な会話作成フローのテスト
    - エージェント応答表示のテスト
    - _要件: 全要件_

---

## 📚 継続的ドキュメント更新タスク

- [x] **手順書の継続的更新** **[🤖 Kiro]**
  - **AWS MCP定期参照**: 2025年最新機能・変更点の確認完了
  - **権限要件の更新**: 2025年版サービス・機能に応じた権限の見直し完了
    - Phase 1-2: `PowerUserAccess` + `AmplifyBackendDeployFullAccess`
    - Phase 3: `AmazonBedrockFullAccess` + `AWSLambdaFullAccess` 追加
  - **セキュリティ要件の更新**: 2025年最新のセキュリティベストプラクティス反映完了
  - **コスト最適化の更新**: 2025年料金体系・新サービスに応じた最適化手法更新完了
  - **トラブルシューティングの拡充**: 最新の問題事例と解決方法の追加完了
  - **学習リソースの更新**: 2025年最新の公式ドキュメント・チュートリアル追加完了
  - _継続的改善: 2025年最新で正確な手順書の維持完了_