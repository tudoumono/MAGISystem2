<!DOCTYPE html>
<html>

<head>
    <title>MAGI Stream Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }

        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }

        .phase {
            background: #2d4a87;
        }

        .system {
            background: #1e3a5f;
        }

        .agent {
            background: #2d5a2d;
        }

        .judge {
            background: #5a2d2d;
        }

        .complete {
            background: #2d5a5a;
        }

        .error {
            background: #5a2d2d;
        }
    </style>
</head>

<body>
    <h1>MAGI Stream Test</h1>
    <button onclick="startStream()">Start MAGI Stream</button>
    <div id="messages"></div>

    <script>
        function startStream() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';

            fetch('/api/magi/stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: 'AIの倫理的課題について教えてください'
                })
            })
                .then(response => {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    function readStream() {
                        return reader.read().then(({ done, value }) => {
                            if (done) {
                                console.log('Stream complete');
                                return;
                            }

                            const chunk = decoder.decode(value, { stream: true });
                            const lines = chunk.split('\n');

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = line.slice(6);
                                        if (data.trim()) {
                                            const message = JSON.parse(data);
                                            displayMessage(message);
                                        }
                                    } catch (e) {
                                        console.warn('Parse error:', line, e);
                                    }
                                }
                            }

                            return readStream();
                        });
                    }

                    return readStream();
                })
                .catch(error => {
                    console.error('Stream error:', error);
                    messagesDiv.innerHTML += `<div class="message error">Error: ${error.message}</div>`;
                });
        }

        function displayMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.type}`;

            let content = '';
            if (message.content) content = message.content;
            else if (message.message) content = message.message;
            else if (message.error) content = `Error: ${message.error}`;

            messageDiv.innerHTML = `
                <strong>[${message.type.toUpperCase()}]</strong> 
                ${message.agentId ? `[${message.agentId.toUpperCase()}] ` : ''}
                ${content}
                <small style="float: right; opacity: 0.7;">${new Date(message.timestamp).toLocaleTimeString()}</small>
            `;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>

</html>