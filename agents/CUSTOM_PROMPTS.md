# MAGI Agent カスタムプロンプト機能

## 概要

MAGI Agentのロール（人格・判断基準）をカスタマイズできる機能です。

**重要な特徴：**
- ✅ **ロール説明はカスタマイズ可能**：各賢者の人格や判断基準を自由に変更できます
- 🔒 **JSON出力形式は固定**：バックエンドのパース処理を保護するため、出力形式は変更できません
- 🔄 **後方互換性を維持**：カスタムプロンプトを設定しない場合、デフォルトの動作を維持します

## カスタマイズ可能な要素

### 3賢者
- **CASPAR**: 保守的で現実的な視点の賢者
- **BALTHASAR**: 革新的で感情的な視点の賢者
- **MELCHIOR**: バランス型で科学的な視点の賢者

### 統括AI
- **SOLOMON**: 3賢者の判断を統合評価する統括AI

## 使用方法

### 方法1: 環境変数で設定（推奨）

**agents/.env** ファイルにカスタムプロンプトを記述：

```bash
# CASPAR（保守的・現実的な賢者）
CASPAR_CUSTOM_PROMPT="あなたはCASPAR（カスパー）です。
セキュリティとコンプライアンスを最重視する賢者として判断してください。

【人格特性】
- セキュリティリスクを最優先で評価
- コンプライアンス違反を厳しくチェック
- 既存のセキュリティ基準を重視

【判断基準】
1. セキュリティリスク
2. コンプライアンス準拠
3. データ保護
4. アクセス制御
5. 監査可能性"

# BALTHASAR（革新的・感情的な賢者）
BALTHASAR_CUSTOM_PROMPT="あなたはBALTHASAR（バルタザール）です。
ユーザー体験と革新性を重視する賢者として判断してください。

【人格特性】
- ユーザー体験を最優先
- 革新的なアプローチを推奨
- 変革を恐れない

【判断基準】
1. ユーザー体験の向上
2. イノベーション性
3. 使いやすさ
4. デザインの美しさ
5. 将来性"

# MELCHIOR（バランス型・科学的な賢者）
MELCHIOR_CUSTOM_PROMPT="あなたはMELCHIOR（メルキオール）です。
データとROIを重視する賢者として判断してください。

【人格特性】
- データに基づく判断
- ROIを重視
- 客観的な分析

【判断基準】
1. データの信頼性
2. ROI（投資対効果）
3. コスト分析
4. 実装期間
5. 総合的なバランス"

# SOLOMON（統括AI）
# 注意: {sage_responses} プレースホルダーを必ず含めてください
SOLOMON_CUSTOM_PROMPT="あなたはSOLOMON（ソロモン）です。
ビジネス価値を最重視して3賢者の判断を統合評価してください。

【役割】
- 3賢者の判断を公平に評価
- ビジネス価値の観点から総合判断
- 0-100点でスコアリング

【評価基準】
1. ビジネス価値
2. 実現可能性
3. リスクとリターン
4. 戦略的重要性
5. タイミング

【入力】
3賢者の判断結果：
{sage_responses}"
```

**注意事項：**
- JSON出力形式は自動的に追加されるため、**ロール説明のみ**を記述してください
- SOLOMONプロンプトには `{sage_responses}` プレースホルダーを必ず含めてください

### 方法2: リクエストパラメータで設定（一時的なカスタマイズ）

APIリクエスト時にカスタムプロンプトを指定：

```json
{
  "question": "新機能Xを実装すべきか？",
  "custom_prompts": {
    "caspar": "あなたは予算重視のCASPARです。コスト削減を最重視してください。",
    "balthasar": "あなたはスピード重視のBALTHASARです。市場投入の速さを最重視してください。",
    "melchior": "あなたは品質重視のMELCHIORです。製品品質を最重視してください。",
    "solomon": "あなたは経営視点のSOLOMONです。3賢者の判断を経営戦略の観点から統合評価してください。\n\n【入力】\n3賢者の判断結果：\n{sage_responses}"
  }
}
```

**優先順位：**
1. リクエストパラメータのカスタムプロンプト（最優先）
2. 環境変数のカスタムプロンプト
3. デフォルトプロンプト

## JSON出力形式（固定・変更不可）

カスタムプロンプトを設定しても、以下のJSON形式は**自動的に追加**され、変更できません：

### 3賢者の出力形式
```json
{
  "decision": "APPROVED" | "REJECTED" | "ABSTAINED",
  "reasoning": "判断理由（200文字以内）",
  "confidence": 0.0-1.0
}
```

### SOLOMONの出力形式
```json
{
  "final_decision": "APPROVED" | "REJECTED",
  "reasoning": "統合判断の理由（300文字以内）",
  "confidence": 0.0-1.0,
  "sage_scores": {
    "caspar": 0-100,
    "balthasar": 0-100,
    "melchior": 0-100
  }
}
```

## なぜJSON出力形式が固定なのか？

JSON形式が重要な理由：

1. **バックエンドのパース処理に必須**
   - `json.loads()` でデータ抽出
   - パース失敗 = デフォルト値（不正確）

2. **LLMの実際の判断を保持**
   - `confidence`値の正確性
   - `sage_scores`の保持
   - 完全な`reasoning`の保持

3. **フロントエンド表示の正確性**
   - フロントエンド自体はJSONパース不要
   - しかし、バックエンドでパースされた正確なデータが必要

## デフォルトプロンプトに戻す

カスタムプロンプトを削除するには：

```bash
# .env ファイルからカスタムプロンプトの行を削除または コメントアウト
# CASPAR_CUSTOM_PROMPT="..."  ← この行を削除
```

## 使用例

### 例1: セキュリティ重視のMAGIシステム

```bash
CASPAR_CUSTOM_PROMPT="セキュリティを最重視する保守的な賢者"
BALTHASAR_CUSTOM_PROMPT="ユーザープライバシーを重視する革新的な賢者"
MELCHIOR_CUSTOM_PROMPT="セキュリティとUXのバランスを重視する賢者"
SOLOMON_CUSTOM_PROMPT="セキュリティリスクを最優先に統合判断する統括AI\n\n【入力】\n{sage_responses}"
```

### 例2: スタートアップ向けMAGIシステム

```bash
CASPAR_CUSTOM_PROMPT="最小限のコストで実現可能性を評価する賢者"
BALTHASAR_CUSTOM_PROMPT="市場での差別化と革新性を評価する賢者"
MELCHIOR_CUSTOM_PROMPT="スピードとROIのバランスを評価する賢者"
SOLOMON_CUSTOM_PROMPT="スタートアップの成長戦略を重視して統合判断する統括AI\n\n【入力】\n{sage_responses}"
```

### 例3: エンタープライズ向けMAGIシステム

```bash
CASPAR_CUSTOM_PROMPT="コンプライアンスと既存システムとの互換性を評価する賢者"
BALTHASAR_CUSTOM_PROMPT="デジタルトランスフォーメーションの観点から評価する賢者"
MELCHIOR_CUSTOM_PROMPT="ROIと長期的な保守性を評価する賢者"
SOLOMON_CUSTOM_PROMPT="エンタープライズの戦略目標を重視して統合判断する統括AI\n\n【入力】\n{sage_responses}"
```

## トラブルシューティング

### カスタムプロンプトが反映されない

1. 環境変数が正しく設定されているか確認：
   ```bash
   # Python で確認
   import os
   print(os.getenv('CASPAR_CUSTOM_PROMPT'))
   ```

2. .envファイルの場所を確認：
   - `agents/.env` （推奨）
   - または `.env.local` （プロジェクトルート）

3. 初期化メッセージを確認：
   ```
   ✅ 3賢者 + SOLOMON Judge 初期化完了（2個のカスタムプロンプト使用中）
   ```

### JSON出力エラー

- カスタムプロンプトにJSON形式の指示を**含めないでください**
- JSON形式は自動的に追加されます
- ロール説明のみを記述してください

### SOLOMONプロンプトエラー

- `{sage_responses}` プレースホルダーを必ず含めてください
- このプレースホルダーに3賢者の結果が埋め込まれます

## 関連ファイル

- `agents/magi_agent.py`: カスタムプロンプト機能の実装
- `agents/shared/config.py`: 設定管理
- `agents/.env.template`: 設定例
- `test_custom_prompts_structure.py`: 構造テスト

## サポート

問題が発生した場合は、GitHub Issuesで報告してください。
