# JavaScript/TypeScript ã§ã® AgentCore Runtime å®Ÿè£…ã‚¬ã‚¤ãƒ‰

## ğŸ¯ é‡è¦ãªä¿®æ­£ï¼ˆ2025-11-10ï¼‰

**ä»¥å‰ã®èª¤ã£ãŸæƒ…å ±ã‚’è¨‚æ­£ã—ã¾ã™ï¼š**

âŒ **èª¤ã‚Š**: `BedrockAgentRuntimeClient`ã¯ä½¿ãˆãªã„ã€æ‰‹å‹•ã§SigV4ç½²åãŒå¿…è¦  
âœ… **æ­£ã—ã„**: `@aws-sdk/client-bedrock-agentcore`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå­˜åœ¨ã—ã€å…¬å¼ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™

## ğŸ“¦ åˆ©ç”¨å¯èƒ½ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

### @aws-sdk/client-bedrock-agentcore

- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v3.927.0ï¼ˆ2025-11-07æ›´æ–°ï¼‰
- **npm**: https://www.npmjs.com/package/@aws-sdk/client-bedrock-agentcore
- **GitHub**: https://github.com/aws/aws-sdk-js-v3/tree/main/clients/client-bedrock-agentcore
- **ãƒ©ã‚¤ã‚»ãƒ³ã‚¹**: Apache-2.0
- **ãƒ¡ãƒ³ãƒ†ãƒŠ**: AWS SDK Botï¼ˆå…¬å¼ï¼‰

```bash
npm install @aws-sdk/client-bedrock-agentcore
```

## ğŸ”§ å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³æ¯”è¼ƒ

### ãƒ‘ã‚¿ãƒ¼ãƒ³A: AWS SDKç›´æ¥å‘¼ã³å‡ºã—ï¼ˆâœ… æ¨å¥¨ï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… TypeScript/JavaScriptã®ã¿ã§å®Œçµ
- âœ… AWSå…¬å¼SDKã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¿è¨¼
- âœ… ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œãŒãƒã‚¤ãƒ†ã‚£ãƒ–
- âœ… å‹å®‰å…¨æ€§ï¼ˆTypeScriptå®Œå…¨å¯¾å¿œï¼‰
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒæ¨™æº–åŒ–
- âœ… é•·æœŸçš„ãªä¿å®ˆæ€§ãŒé«˜ã„

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- âš ï¸ AWSå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«JavaScriptä¾‹ãŒå°‘ãªã„ï¼ˆPythonä¾‹ã®ã¿ï¼‰
- âš ï¸ æ–°ã—ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãŸã‚ã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æƒ…å ±ãŒå°‘ãªã„

### ãƒ‘ã‚¿ãƒ¼ãƒ³B: Python Proxyãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆPhase 2å®Ÿè£…ï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… Phase 2ã§æ¤œè¨¼æ¸ˆã¿ï¼ˆ11.96ç§’ã€383ã‚¤ãƒ™ãƒ³ãƒˆï¼‰
- âœ… Pythonå´ã®boto3å®Ÿè£…ãŒãã®ã¾ã¾ä½¿ãˆã‚‹
- âœ… èªè¨¼æƒ…å ±ã®ç®¡ç†ãŒä¸€å…ƒåŒ–
- âœ… è±Šå¯ŒãªPythonã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ 

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- âŒ Pythonãƒ—ãƒ­ã‚»ã‚¹ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰
- âŒ ãƒ—ãƒ­ã‚»ã‚¹é–“é€šä¿¡ã®è¤‡é›‘ã•
- âŒ ãƒ‡ãƒãƒƒã‚°ã®é›£ã—ã•
- âŒ è¨€èªæ··åœ¨ã«ã‚ˆã‚‹ä¿å®ˆã‚³ã‚¹ãƒˆ

## ğŸ’» å®Ÿè£…ä¾‹

### ãƒ‘ã‚¿ãƒ¼ãƒ³A: AWS SDKç›´æ¥å®Ÿè£…

#### 1. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install @aws-sdk/client-bedrock-agentcore
```

#### 2. Next.js API Routeå®Ÿè£…

```typescript
// app/api/invoke/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { 
  BedrockAgentCoreClient, 
  InvokeAgentRuntimeCommand 
} from '@aws-sdk/client-bedrock-agentcore';

export async function POST(request: NextRequest) {
  try {
    const { question } = await request.json();
    
    // 1. BedrockAgentCoreClientã®åˆæœŸåŒ–
    const client = new BedrockAgentCoreClient({
      region: process.env.AWS_REGION || 'ap-northeast-1',
      credentials: {
        accessKeyId: process.env.AWS_ACCESS_KEY_ID!,
        secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY!,
        sessionToken: process.env.AWS_SESSION_TOKEN
      }
    });
    
    // 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆï¼ˆ33æ–‡å­—ä»¥ä¸Šå¿…è¦ï¼‰
    const sessionId = `session-${Date.now()}-${Math.random().toString(36).substring(2)}`;
    
    // 3. ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰æº–å‚™
    const payload = JSON.stringify({ question });
    
    // 4. InvokeAgentRuntimeCommandã®å®Ÿè¡Œ
    const command = new InvokeAgentRuntimeCommand({
      agentRuntimeArn: process.env.MAGI_AGENT_ARN!,
      runtimeSessionId: sessionId,
      payload: new TextEncoder().encode(payload)
    });
    
    const response = await client.send(command);
    
    // 5. Server-Sent Eventsã§ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
    const stream = new ReadableStream({
      async start(controller) {
        try {
          // response.responseã¯AsyncIterableStream
          if (response.response) {
            for await (const event of response.response) {
              // ã‚¤ãƒ™ãƒ³ãƒˆã‚’SSEå½¢å¼ã§é€ä¿¡
              const sseData = `data: ${JSON.stringify(event)}\n\n`;
              controller.enqueue(new TextEncoder().encode(sseData));
            }
          }
          controller.close();
        } catch (error) {
          console.error('Stream processing error:', error);
          const errorEvent = {
            type: 'error',
            data: { 
              error: error instanceof Error ? error.message : 'Unknown error',
              code: 'STREAM_PROCESSING_ERROR'
            }
          };
          controller.enqueue(
            new TextEncoder().encode(`data: ${JSON.stringify(errorEvent)}\n\n`)
          );
          controller.close();
        }
      }
    });
    
    // 6. SSEãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
    return new NextResponse(stream, {
      headers: {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive',
        'Access-Control-Allow-Origin': '*',
      },
    });
    
  } catch (error) {
    console.error('API error:', error);
    return NextResponse.json(
      { 
        error: 'Internal server error', 
        details: error instanceof Error ? error.message : 'Unknown error' 
      },
      { status: 500 }
    );
  }
}

// CORSå¯¾å¿œ
export async function OPTIONS() {
  return new NextResponse(null, {
    status: 200,
    headers: {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    },
  });
}
```

#### 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆï¼ˆuseChatï¼‰

```typescript
// hooks/useMAGIChat.ts
import { useChat } from 'ai/react';

export function useMAGIChat() {
  const { messages, append, isLoading, error } = useChat({
    api: '/api/invoke',
    onError: (error) => {
      console.error('MAGI Chat Error:', error);
    },
    onFinish: (message) => {
      console.log('MAGI Decision Complete:', message);
    }
  });
  
  return { messages, append, isLoading, error };
}
```

```typescript
// components/MAGIChat.tsx
'use client';

import { useMAGIChat } from '@/hooks/useMAGIChat';

export function MAGIChat() {
  const { messages, append, isLoading } = useMAGIChat();
  
  const handleSubmit = async (question: string) => {
    await append({
      role: 'user',
      content: question
    });
  };
  
  return (
    <div>
      {messages.map((message, i) => (
        <div key={i}>
          <strong>{message.role}:</strong> {message.content}
        </div>
      ))}
      
      <button 
        onClick={() => handleSubmit('æ–°ã—ã„AIã‚·ã‚¹ãƒ†ãƒ ã‚’å°å…¥ã™ã¹ãã‹ï¼Ÿ')}
        disabled={isLoading}
      >
        {isLoading ? 'å‡¦ç†ä¸­...' : 'MAGIæ±ºå®šã‚’å®Ÿè¡Œ'}
      </button>
    </div>
  );
}
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³B: Python Proxyãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆPhase 2å®Ÿè£…ï¼‰

Phase 2ã§å‹•ä½œç¢ºèªæ¸ˆã¿ã®å®Ÿè£…ã‚’ç¶™ç¶šä½¿ç”¨ã™ã‚‹å ´åˆï¼š

```typescript
// app/api/invocations/route.tsï¼ˆæ—¢å­˜å®Ÿè£…ï¼‰
import { spawn } from 'child_process';

export async function POST(request: NextRequest) {
  const body = await request.json();
  
  const stream = new ReadableStream({
    start(controller) {
      // Pythonãƒ—ãƒ­ã‚»ã‚¹ã‚’èµ·å‹•
      const pythonProcess = spawn('python', ['magi_agent.py'], {
        stdio: ['pipe', 'pipe', 'pipe']
      });
      
      // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
      pythonProcess.stdin.write(JSON.stringify(body));
      pythonProcess.stdin.end();
      
      // æ¨™æº–å‡ºåŠ›ã‚’å‡¦ç†
      pythonProcess.stdout.on('data', (data) => {
        controller.enqueue(new TextEncoder().encode(`data: ${data}\n\n`));
      });
      
      pythonProcess.on('close', () => {
        controller.close();
      });
    }
  });
  
  return new NextResponse(stream, {
    headers: {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      'Connection': 'keep-alive',
    },
  });
}
```

## ğŸ“Š å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³æ¯”è¼ƒè¡¨

| é …ç›® | AWS SDKç›´æ¥ | HTTP + SigV4 | Python Proxy |
|------|------------|--------------|--------------|
| å®Ÿè£…ã®ç°¡æ½”ã• | â­â­â­â­â­ | â­â­ | â­â­â­ |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| ä¿å®ˆæ€§ | â­â­â­â­â­ | â­â­â­ | â­â­ |
| æ—¢å­˜è³‡ç”£æ´»ç”¨ | â­â­ | â­â­ | â­â­â­â­â­ |
| ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ  | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ |
| å‹å®‰å…¨æ€§ | â­â­â­â­â­ | â­â­â­ | â­â­ |
| ãƒ‡ãƒãƒƒã‚°å®¹æ˜“æ€§ | â­â­â­â­â­ | â­â­â­ | â­â­ |

## ğŸ¯ æ¨å¥¨å®Ÿè£…æˆ¦ç•¥

### æ–°è¦å®Ÿè£…ã®å ´åˆ

**AWS SDKç›´æ¥å‘¼ã³å‡ºã—ï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³Aï¼‰ã‚’å¼·ãæ¨å¥¨**

ç†ç”±ï¼š
- TypeScript/JavaScriptã®ã¿ã§å®Œçµ
- AWSå…¬å¼SDKã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¿è¨¼
- é•·æœŸçš„ãªä¿å®ˆæ€§ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- å‹å®‰å…¨æ€§ã«ã‚ˆã‚‹é–‹ç™ºåŠ¹ç‡å‘ä¸Š

### Phase 2ã‹ã‚‰ã®ç§»è¡Œã®å ´åˆ

**æ®µéšçš„ç§»è¡Œã‚’æ¨å¥¨**

1. **Phase 2.5**: Pythonå®Ÿè£…ã‚’ä¸€æ—¦ãã®ã¾ã¾ä½¿ç”¨
2. **Phase 3**: TypeScriptå®Ÿè£…ã‚’ä¸¦è¡Œæ§‹ç¯‰
3. **Phase 4**: å‹•ä½œç¢ºèªå¾Œã«åˆ‡ã‚Šæ›¿ãˆ
4. **Phase 5**: Pythonä¾å­˜ã‚’å®Œå…¨å‰Šé™¤

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### èªè¨¼æƒ…å ±ã®ç®¡ç†

```typescript
// âŒ æ‚ªã„ä¾‹ï¼šãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ç›´æ¥å‘¼ã³å‡ºã—
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§AWSèªè¨¼æƒ…å ±ã‚’éœ²å‡ºã—ã¦ã—ã¾ã†
const client = new BedrockAgentCoreClient({
  region: 'ap-northeast-1',
  credentials: {
    accessKeyId: 'AKIA...', // å±é™ºï¼
    secretAccessKey: 'xxx'  // å±é™ºï¼
  }
});

// âœ… è‰¯ã„ä¾‹ï¼šNext.jsãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§å‘¼ã³å‡ºã—
// app/api/invoke/route.tsï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ï¼‰
const client = new BedrockAgentCoreClient({
  region: process.env.AWS_REGION,
  credentials: {
    accessKeyId: process.env.AWS_ACCESS_KEY_ID!,
    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY!,
    sessionToken: process.env.AWS_SESSION_TOKEN
  }
});
```

### æ¨å¥¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (Next.js Client)
    â†“ useChat() â†’ HTTP POST /api/invoke
Next.jsãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (API Route) â† èªè¨¼ãƒ»èªå¯å±¤
    â†“ BedrockAgentCoreClient
AgentCore Runtime (AWS)
    â†“
Python magi_agent.py
    â†“
3è³¢è€… + SOLOMON Judge
```

**ãƒ¡ãƒªãƒƒãƒˆï¼š**
- âœ… AWSèªè¨¼æƒ…å ±ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«éœ²å‡ºã—ãªã„
- âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®ä¸€å…ƒåŒ–
- âœ… ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ»èªå¯ã®å®Ÿè£…ãŒå®¹æ˜“
- âœ… ç›£æŸ»ãƒ­ã‚°ã®ä¸€å…ƒç®¡ç†

## ğŸ“š å‚è€ƒè³‡æ–™

### AWSå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [Invoke an AgentCore Runtime agent](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/runtime-invoke-agent.html)
- [AWS SDK for JavaScript v3](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/)

### npmãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
- [@aws-sdk/client-bedrock-agentcore](https://www.npmjs.com/package/@aws-sdk/client-bedrock-agentcore)
- [GitHub Repository](https://github.com/aws/aws-sdk-js-v3/tree/main/clients/client-bedrock-agentcore)

### Phase 2å‹•ä½œç¢ºèª
- `agents/tests/test_magi2.py` - HTTP POSTç‰ˆãƒ†ã‚¹ãƒˆï¼ˆå‹•ä½œç¢ºèªæ¸ˆã¿ï¼‰
- `agents/backend/app/api/invocations/route.ts` - Python Proxyå®Ÿè£…ï¼ˆå‹•ä½œç¢ºèªæ¸ˆã¿ï¼‰
- `agents/PHASE2_BASELINE_COMPLETE.md` - Phase 2å®Œäº†ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### Phase 3: TypeScriptå®Ÿè£…ã¸ã®ç§»è¡Œ

1. **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
   ```bash
   cd agents/backend
   npm install @aws-sdk/client-bedrock-agentcore
   ```

2. **æ–°ã—ã„API Routeä½œæˆ**
   ```bash
   # æ—¢å­˜ã®Python Proxyå®Ÿè£…ã‚’ä¿æŒ
   agents/backend/app/api/invocations/route.tsï¼ˆæ—¢å­˜ï¼‰
   
   # æ–°ã—ã„TypeScriptå®Ÿè£…ã‚’è¿½åŠ 
   agents/backend/app/api/invoke-ts/route.tsï¼ˆæ–°è¦ï¼‰
   ```

3. **ä¸¦è¡Œãƒ†ã‚¹ãƒˆ**
   - Python Proxyç‰ˆ: `/api/invocations`
   - TypeScriptç‰ˆ: `/api/invoke-ts`
   - ä¸¡æ–¹ã®å‹•ä½œã‚’æ¯”è¼ƒæ¤œè¨¼

4. **åˆ‡ã‚Šæ›¿ãˆ**
   - TypeScriptç‰ˆã®å‹•ä½œç¢ºèªå®Œäº†å¾Œ
   - `/api/invocations`ã‚’TypeScriptå®Ÿè£…ã«ç½®ãæ›ãˆ
   - Pythonä¾å­˜ã‚’æ®µéšçš„ã«å‰Šé™¤

5. **æœ€çµ‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**
   - Pythoné–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
   - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°
   - ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã®ç°¡ç´ åŒ–
